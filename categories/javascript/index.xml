<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Javascript on Clint Berry</title>
    <link>http://clintberry.github.io/categories/javascript/</link>
    <description>Recent content in Javascript on Clint Berry</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Sat, 01 Sep 2012 00:00:00 +0000</lastBuildDate>
    <atom:link href="http://clintberry.github.io/categories/javascript/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Backbone.js apps with Authentication Tutorial</title>
      <link>http://clintberry.github.io/2012/backbone-js-apps-authentication-tutorial/</link>
      <pubDate>Sat, 01 Sep 2012 00:00:00 +0000</pubDate>
      
      <guid>http://clintberry.github.io/2012/backbone-js-apps-authentication-tutorial/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://clintberry.github.io/images/backbonelocked.png&#34; alt=&#34;backbonelocked&#34; title=&#34;backbonelocked&#34; width=&#34;568&#34; height=&#34;111&#34; class=&#34;alignnone size-full wp-image-670&#34; /&gt;&lt;/p&gt;

&lt;p&gt;At my current company I am working on my first large-scale production backbone.js app and I couldn&amp;#8217;t be happier. After using backbone.js for a few months I have caught the vision and I am becoming more and more proficient. But every once and a while I still run into problems I would consider basic, but I can&amp;#8217;t seem to find much help on the interwebs. Authentication with backbone.js apps was one of those problems. So I am posting the solution I came up with in hopes it will benefit someone else, and hopefully will garner some feedback or potentially better ways to solve authentication with Backbone.js.&lt;/p&gt;

&lt;h4 id=&#34;starting-code-base:73b85921beb05e353da557a09d786139&#34;&gt;Starting Code Base&lt;/h4&gt;

&lt;p&gt;To start this tutorial, I will be using an already created backbone.js application called &lt;a href=&#34;https://github.com/ccoenraets/backbone-directory&#34; title=&#34;Backbone Directory&#34; target=&#34;_blank&#34;&gt;Backbone Directory&lt;/a&gt;, created by &lt;a href=&#34;http://coenraets.org/blog/2012/02/sample-app-with-backbone-js-and-twitter-bootstrap/&#34; title=&#34;Sample Backbone Bootstrap app&#34; target=&#34;_blank&#34;&gt;Christophe Coenraets&lt;/a&gt; who has some great tutorials and information about backbone on his blog. He has some mobile versions of the app in the code base as well, but we will be working in the &amp;#8220;web&amp;#8221; directory.&lt;/p&gt;

&lt;h4 id=&#34;project-overview:73b85921beb05e353da557a09d786139&#34;&gt;Project Overview&lt;/h4&gt;

&lt;p&gt;Backbone Directory uses the Slim PHP framework on the server to communicate with backbone, but the principles we will be going over are language agnostic. In addition, Slim is based on the Sinatra (Ruby) methodology which in turn translates to Express.js framework for Node.js (JavaScript), and Tornado (Python).&lt;/p&gt;

&lt;h4 id=&#34;setting-up-very-basic-server-side-authentication:73b85921beb05e353da557a09d786139&#34;&gt;Setting Up (Very) Basic Server Side Authentication&lt;/h4&gt;

&lt;p&gt;To get this started, we need to setup the server side login functions, and also a way to protect API requests so no data goes to anyone that isn&amp;#8217;t authenticated. First, let&amp;#8217;s add a login function to the api/index.php in the web directory:&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;// file: api/index.php
session_start(); // Add this to the top of the file

/**
 * Quick and dirty login function with hard coded credentials (admin/admin)
 * This is just an example. Do not use this in a production environment
 */
function login() {
    if(!empty($_POST[&amp;#039;email&amp;#039;]) &amp;&amp; !empty($_POST[&amp;#039;password&amp;#039;])) {
        // normally you would load credentials from a database. 
        // This is just an example and is certainly not secure
        if($_POST[&amp;#039;email&amp;#039;] == &amp;#039;admin&amp;#039; &amp;&amp; $_POST[&amp;#039;password&amp;#039;] == &amp;#039;admin&amp;#039;) {
            $user = array(&#34;email&#34;=&amp;gt;&#34;admin&#34;, &#34;firstName&#34;=&amp;gt;&#34;Clint&#34;, &#34;lastName&#34;=&amp;gt;&#34;Berry&#34;, &#34;role&#34;=&amp;gt;&#34;user&#34;);
            $_SESSION[&amp;#039;user&amp;#039;] = $user;
            echo json_encode($user);
        }
        else {
            echo &amp;#039;{&#34;error&#34;:{&#34;text&#34;:&#34;You shall not pass...&#34;}}&amp;#039;;
        }
    }
    else {
        echo &amp;#039;{&#34;error&#34;:{&#34;text&#34;:&#34;Username and Password are required.&#34;}}&amp;#039;;
    }
}
&lt;/pre&gt;

&lt;p&gt;This is a very basic login function that is obviously not secure, but will do the job for us, since our focus is really on the backbone side of things. The key thing to note here, is that since we are using backbone, even the login function works as a JSON api request. We don&amp;#8217;t generate any HTML, we simply send back JSON data with a user identity, or an error if something went wrong. Now we need to associate this function with a route in Slim, so add the following code under the other defined routes in index.php:&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;// file: api/index.php
// I add the login route as a post, since we will be posting the login form info
$app-&amp;gt;post(&amp;#039;/login&amp;#039;, &amp;#039;login&amp;#039;);

&lt;/pre&gt;

&lt;p&gt;Now we also need to make sure no data gets sent to anyone that isn&amp;#8217;t authorized. So now we define an authorize function to check that a user has the right permissions to get the data:&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;// File: api/index.php
/**
 * Authorise function, used as Slim Route Middlewear
 */
function authorize($role = &#34;user&#34;) {
    return function () use ( $role ) {
        // Get the Slim framework object
        $app = Slim::getInstance();
        // First, check to see if the user is logged in at all
        if(!empty($_SESSION[&amp;#039;user&amp;#039;])) {
            // Next, validate the role to make sure they can access the route
            // We will assume admin role can access everything
            if($_SESSION[&amp;#039;user&amp;#039;][&amp;#039;role&amp;#039;] == $role || 
                $_SESSION[&amp;#039;user&amp;#039;][&amp;#039;role&amp;#039;] == &amp;#039;admin&amp;#039;) {
                //User is logged in and has the correct permissions... Nice!
                return true;
            }
            else {
                // If a user is logged in, but doesn&amp;#039;t have permissions, return 403
                $app-&amp;gt;halt(403, &amp;#039;You shall not pass!&amp;#039;);
            }
        }
        else {
            // If a user is not logged in at all, return a 401
            $app-&amp;gt;halt(401, &amp;#039;You shall not pass!&amp;#039;);
        }
    };
}
&lt;/pre&gt;

&lt;p&gt;The authorize function uses some PHP closure Kung Fu, but the key is to return HTTP error codes to backbone. In our case we are going to return a 401 error (unauthorized) if a user is trying to access something they need to be logged in for, and a 403 (forbidden) if the user is logged in but doesn&amp;#8217;t have enough privs to get the data he wants.&lt;/p&gt;

&lt;div class=&#34;alert alert-info&#34;&gt;
  &lt;strong&gt;More Info:&lt;/strong&gt; Check out &lt;a href=&#34;http://www.slimframework.com/documentation/stable#routing-middleware&#34; title=&#34;Slim Route Middlewear&#34; target=&#34;_blank&#34;&gt;Slim Route Middleware&lt;/a&gt; and &lt;a href=&#34;http://php.net/manual/en/functions.anonymous.php&#34; title=&#34;PHP Closures&#34; target=&#34;_blank&#34;&gt;PHP Closures&lt;/a&gt;
&lt;/div&gt;

&lt;p&gt;The last thing we need to do in our server-side code is add the middleware to the routes we want to protect:&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;// File: api/index.php
$app-&amp;gt;get(&amp;#039;/employees&amp;#039;, authorize(&amp;#039;user&amp;#039;), &amp;#039;getEmployees&amp;#039;);
$app-&amp;gt;get(&amp;#039;/employees/:id&amp;#039;,    authorize(&amp;#039;user&amp;#039;),&amp;#039;getEmployee&amp;#039;);
$app-&amp;gt;get(&amp;#039;/employees/:id/reports&amp;#039;,    authorize(&amp;#039;admin&amp;#039;),&amp;#039;getReports&amp;#039;);
$app-&amp;gt;get(&amp;#039;/employees/search/:query&amp;#039;, authorize(&amp;#039;user&amp;#039;),&amp;#039;getEmployeesByName&amp;#039;);
$app-&amp;gt;get(&amp;#039;/employees/modifiedsince/:timestamp&amp;#039;, authorize(&amp;#039;user&amp;#039;), &amp;#039;findByModifiedDate&amp;#039;);
&lt;/pre&gt;

&lt;h4 id=&#34;setting-up-backbone-views:73b85921beb05e353da557a09d786139&#34;&gt;Setting Up Backbone Views&lt;/h4&gt;

&lt;p&gt;Now let&amp;#8217;s get to the good stuff: Setting up our backbone views. For authentication we will of course need a login view:&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;// File: web/js/views/login.js
window.LoginView = Backbone.View.extend({

    initialize:function () {
        console.log(&amp;#039;Initializing Login View&amp;#039;);
    },

    events: {
        &#34;click #loginButton&#34;: &#34;login&#34;
    },

    render:function () {
        $(this.el).html(this.template());
        return this;
    },

    login:function (event) {
        event.preventDefault(); // Don&amp;#039;t let this button submit the form
        $(&amp;#039;.alert-error&amp;#039;).hide(); // Hide any errors on a new submit
        var url = &amp;#039;../api/login&amp;#039;;
        console.log(&amp;#039;Loggin in... &amp;#039;);
        var formValues = {
            email: $(&amp;#039;#inputEmail&amp;#039;).val(),
            password: $(&amp;#039;#inputPassword&amp;#039;).val()
        };

        $.ajax({
            url:url,
            type:&amp;#039;POST&amp;#039;,
            dataType:&#34;json&#34;,
            data: formValues,
            success:function (data) {
                console.log([&#34;Login request details: &#34;, data]);
               
                if(data.error) {  // If there is an error, show the error messages
                    $(&amp;#039;.alert-error&amp;#039;).text(data.error.text).show();
                }
                else { // If not, send them back to the home page
                    window.location.replace(&amp;#039;#&amp;#039;);
                }
            }
        });
    }
});

&lt;/pre&gt;

&lt;p&gt;This view is pretty straight forward. It renders the login template, and put a click event handler on the login button. The event handler fires the login function when the button is clicked and sends an ajax request to our php login function. If an error comes back, we put it in the error div and show that div.&lt;/p&gt;

&lt;p&gt;Here is the login template code:&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;&amp;lt;!-- File: web/tpl/Login.html --&amp;gt;
&amp;lt;h1&amp;gt;Login&amp;lt;/h1&amp;gt;
&amp;lt;div class=&#34;alert alert-error&#34; style=&#34;display:none;&#34;&amp;gt;
&amp;lt;/div&amp;gt;
&amp;lt;form class=&#34;form-horizontal&#34;&amp;gt;
  &amp;lt;div class=&#34;control-group&#34;&amp;gt;
    &amp;lt;label class=&#34;control-label&#34; for=&#34;inputEmail&#34;&amp;gt;Email&amp;lt;/label&amp;gt;
    &amp;lt;div class=&#34;controls&#34;&amp;gt;
      &amp;lt;input type=&#34;text&#34; id=&#34;inputEmail&#34; placeholder=&#34;Email&#34;&amp;gt;
    &amp;lt;/div&amp;gt;
  &amp;lt;/div&amp;gt;
  &amp;lt;div class=&#34;control-group&#34;&amp;gt;
    &amp;lt;label class=&#34;control-label&#34; for=&#34;inputPassword&#34;&amp;gt;Password&amp;lt;/label&amp;gt;
    &amp;lt;div class=&#34;controls&#34;&amp;gt;
      &amp;lt;input type=&#34;password&#34; id=&#34;inputPassword&#34; placeholder=&#34;Password&#34;&amp;gt;
    &amp;lt;/div&amp;gt;
  &amp;lt;/div&amp;gt;
  &amp;lt;div class=&#34;control-group&#34;&amp;gt;
    &amp;lt;div class=&#34;controls&#34;&amp;gt;
      &amp;lt;button type=&#34;submit&#34; class=&#34;btn&#34; id=&#34;loginButton&#34;&amp;gt;Sign in&amp;lt;/button&amp;gt;
    &amp;lt;/div&amp;gt;
  &amp;lt;/div&amp;gt;
&amp;lt;/form&amp;gt;
&lt;/pre&gt;

&lt;h4 id=&#34;telling-backbone-how-to-handle-401-038-403-errors-ajaxsetup:73b85921beb05e353da557a09d786139&#34;&gt;Telling Backbone How to Handle 401 &amp;#038; 403 Errors (ajaxSetup)&lt;/h4&gt;

&lt;p&gt;Now here comes the kicker. We need backbone/jquery to catch any requests that return a 401 or 403 error and handle those requests appropriately. The method I have used to do this is to call the jquery function ajaxSetup which allows us to watch for certain status codes and to handle them appropriately.&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;// File: web/js/main.js
// Tell jQuery to watch for any 401 or 403 errors and handle them appropriately
$.ajaxSetup({
    statusCode: {
        401: function(){
            // Redirec the to the login page.
            window.location.replace(&amp;#039;/#login&amp;#039;);
         
        },
        403: function() {
            // 403 -- Access denied
            window.location.replace(&amp;#039;/#denied&amp;#039;);
        }
    }
});
&lt;/pre&gt;

&lt;p&gt;Now all 401s and 403s will be redirected to appropriate place. (I haven&amp;#8217;t implemented the &amp;#8220;denied&amp;#8221; view yet, but you get the idea)&lt;/p&gt;

&lt;p&gt;Lastly we update the backbone routing to include the login url and login view:&lt;/p&gt;

&lt;pre class=&#34;wp-code-highlight prettyprint&#34;&gt;// File: web/js/main.js
window.Router = Backbone.Router.extend({

    routes: {
        &#34;&#34;: &#34;home&#34;,
        &#34;contact&#34;: &#34;contact&#34;,
        &#34;employees/:id&#34;: &#34;employeeDetails&#34;,
        &#34;login&#34; : &#34;login&#34;
    },

// ...

    login: function() {
        $(&amp;#039;#content&amp;#039;).html(new LoginView().render().el);
    }
}
&lt;/pre&gt;

&lt;h4 id=&#34;the-final-word-and-source-code:73b85921beb05e353da557a09d786139&#34;&gt;The Final Word (and source code)&lt;/h4&gt;

&lt;p&gt;That is it! You should now have a password protected REST API for BackboneJS. I have posted the &lt;a href=&#34;https://github.com/clintberry/backbone-directory-auth&#34; title=&#34;Backbone Authentication&#34; target=&#34;_blank&#34;&gt;project to github (here)&lt;/a&gt;, so feel free to check out the code and see it in action. Currently, you will need PHP/Apache with MySQL setup and the database imported. I am working on a Vagrant file for the project so you will be able to see it in action without setting up your own server.&lt;/p&gt;

&lt;p&gt;As always, let me know if you have any questions or suggestions.&lt;/p&gt;

&lt;p&gt;Source Code: &lt;a href=&#34;https://github.com/clintberry/backbone-directory-auth&#34; title=&#34;Backbone Authentication&#34; target=&#34;_blank&#34;&gt;&lt;a href=&#34;https://github.com/clintberry/backbone-directory-auth&#34;&gt;https://github.com/clintberry/backbone-directory-auth&lt;/a&gt;&lt;/a&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>